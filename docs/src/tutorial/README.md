# Tutorial (JavaScript)

::: danger

Note: This site is work-in-progress and the mainnet library is currently in a prototype stage. 
Things may and will change randomly. There is no backward compatibility guarantee yet, 
even though we try not to break things too often. Use at your own risk. To see the old site with the full plan 
(yet to be implemented), go [here](https://web.archive.org/web/20200810182937/https://mainnet.cash/).

:::

::: tip A working demo

You can see a fully working demo [here](https://jsfiddle.net/ghn19jmu/2/) and a video of it [here](https://www.youtube.com/watch?v=6Z4ef2Isod4)

:::

<!-- Your stack: Browser + IndexedDB PHP Other -->

## Let's get programming

Note that this tutorial describes `Browser + IndexedDB` approach, which means that the wallets will be created 
and persisted inside of a user browser. See [Other programming languages](/tutorial/other_langs.html) for other approaches.

To get started using Bitcoin Cash on your site, include this tag in your `<head>` section:

```html
<script src="https://cdn.mainnet.cash/mainnet-0.0.2.js"
 integrity="sha384-tEB+lsMkD2DHlGwMMtrzEpFiBxK2anPv3Cx8qNXiz5vPIBAoIvk4/O5sZyL3WsDs"
 crossorigin="anonymous"></script>
```

<!-- 
sha matching:
curl https://cdn.mainnet.cash/mainnet-0.0.2.js | openssl dgst -sha384 -binary | openssl base64 -A 
-->

Note that the `integrity` part guarantees that the script haven't been tampered with. So if a hacker replaces it,
the user's browser will not run the script. Or you can download the library and serve it locally.

Now, you can create a test wallet:

```js
const wallet = await TestNetWallet.newRandom();
```

This wallet will not be persisted, if a user closes his browser, it's gone forever. See below for persistent wallets.

This creates a **TestNet** wallet.

::: tip What is TestNet? Where to get TestNet money and a wallet?

`TestNet` is where you test your application. TestNet money has no price. Opposite of TestNet is `MainNet`, 
which is what people usually mean when they talk about Bitcoin Cash network.  You can get free TestNet money [here](https://faucet.fullstack.cash/).
If you need a wallet that supports the TestNet, download [Electron Cash](https://electroncash.org/) and 
run it using `electron-cash --testnet` flag. For example, on MacOS that would be:

`/Applications/Electron-Cash.app/Contents/MacOS/Electron-Cash --testnet`


:::

To create a MainNet wallet (Bitcoin Cash production network): 

```js
const wallet = await Wallet.newRandom();
```

If you want to create a wallet from a WIF (private key), use this call:

```js
const wallet = Wallet.fromWIF('.....');
```

## Named wallets (persistent)

Named wallets are used to saved the private key generated by the browser, so that you 
can run ```await Wallet.named(`user`)``` and always get the same wallet back.

Note that it's better to run something like ```await Wallet.named(`user:${id}`)```, i.e. use some ID of the user, 
so that if the same browser has multiple users, they'll all get their own wallet. (Like, if a user has multiple accounts on your site)

To create a persistent wallet (saved to the IndexedDB of user's browser):

```js
const wallet = await TestNetWallet.named('user:1234');
```

`user:1234` is an optional name for the wallet. The wallet is saved in user's browser for future re-use.

## Getting the balance

To get the balance of the wallet you can do this:

```js
await seller.getBalance('usd') // 0.00
await seller.getBalance('bch') // 0.00
await seller.getBalance('sat') // 0
```

You can ask for `usd`, `sat`, `bch` (or `satoshi`, `satoshis`, `sats` - just in case you forget the exact name).

- 1 satoshi = 0.000 000 01 Bitcoin Cash
- 1 Bitcoin Cash = 100,000,000 satoshis

`USD` returns the amount at the current exchange rate. 

## Sending money

Let's create another wallet and send some of our money there:

```js
const seller = new TestNetHdWallet('seller');

const txData = await wallet.send([
    [seller.depositAddress(), 0.01, 'USD'],
]);
```

Note that you can send to many addresses at once.

Let's print the balance of the seller's wallet:

```js
console.log(await seller.getBalance('USD'));
// 0.01
```

Great! You've just made your first transaction!

Now you can send all of your money somewhere else:

```js
const txData = await seller.sendMax(wallet.depositAddress());
```

## Waiting for a transaction

### QR codes

Let's say you want to display a QR code for you user to pay you money and show an alert when money arrives?

Let's display a QR code first. Create a placeholder first:

```html
<p style="text-align: center;">
    <img src="https://cdn.mainnet.cash/wait.svg" style="width: 15em;" id="deposit">
</p>
```

Then you can replace it with an actual QR code of the deposit address:

```js
document.querySelector('#deposit').src = wallet.getDepositQr().src;
```

### Waiting

Currently, the only way to wait for a tx is to poll the balance (this will improve later):

```js
function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

while((await wallet.getBalance('usd')) < 1.0) {
  await sleep(0.1);
}

alert('Transaction has arrived!');
````

## Escrow contracts

::: warning 
Not fully tested yet
:::

Ok, let's now assume that you are building a service where you want to connect a buyer and a seller (a freelance marketplace 
or a non-custodial exchange), but at the same time you don't want to hold anyone's money, 
but only act as an arbiter in case something goes wrong. It's possible in Bitcoin Cash and it's called "an escrow contract".

You'll need three addresses for this: `buyer`, `seller` and `arbiter`. 

Note: The source for the contract is [here](https://github.com/mainnet-cash/mainnet-js/blob/a35c3ff9590eb04e03b122d7bb2d4bbb12150d66/src/contract/escrow/EscrowContract.ts#L98-L118). 

1) Buyer sends the money to the contract and could then release the money to the seller 
2) The seller could refund the buyer
3) Arbiter can either complete the transaction to the seller or refund to the buyer, but cannot steal the money 

```js
let escrow = new EscrowContract({
  arbiterAddr: arbiter.getDepositAddress(),
  buyerAddr: buyer.getDepositAddress(),
  sellerAddr: seller.getDepositAddress(),
});
```

You can now send money to the contract:

```js
await buyer.send([ [ escrow.getAddress(), 450000, "satoshis" ], ]);
``` 

Check the balance of the contract (in satoshis):

```js
await escrow.getBalance()
// 450000
```

TODO: a function to convert satoshis to USD and vice versa - that's coming

Now, we can execute the necessary functions:

1) Buyer releases the funds
```js
await escrow.run(buyer.privateKeyWif, "spend");
```

2) Seller refunds
```js
await escrow.run(seller.privateKeyWif, "refund");
```

3) Arbiter releases the funds or refunds
```js
await escrow.run(arbiter.privateKeyWif, "spend");
await escrow.run(arbiter.privateKeyWif, "refund");
```

### Saving the contract to the database

The arbiter needs to save the contract somewhere (in a database or some other storage), so that when the time comes,
he could execure the necessary functions:

Save:

```js
const contractId = escrow.toString();
```

Restore it later:

```js
const restoredEscrow = EscrowContract.fromId(contractId);
```

## CashScript

Somewhat done, but not yet documented...

## RegTest wallets

TODO: How to run the local development environment

RegTest (local development) wallets, use this:

::: tip What is RegTest?

You might also hear about `RegTest` mode, which is when you run your Bitcoin Cash node 
locally and you can get as many test coins as you need, but they exist on your machine only. 
RegTest wallets are supported by mainnet library.

:::

```js
const wallet = await RegTestWallet.newRandom();
```

To be continued...

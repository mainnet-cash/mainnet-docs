# JavaScript (in browser)

::: danger

Note: This site is work-in-progress and the mainnet library is currently in a prototype stage.
Things may and will change randomly. There is no backward compatibility guarantee yet,
even though we try not to break things too often. Use at your own risk. To see the old site with the full plan
(yet to be implemented), go [here](https://web.archive.org/web/20200810182937/https://mainnet.cash/).

:::

::: tip A working demo

You can see a fully working demo [here](https://jsfiddle.net/7emLk4na/1/) and a video of it [here](https://www.youtube.com/watch?v=6Z4ef2Isod4)

:::

<!-- Your stack: Browser + IndexedDB PHP Other -->

## Let's get programming

Note that this tutorial describes `Browser + IndexedDB` approach, which means that the wallets will be created
and persisted inside of a user browser. See [calling the REST API](/tutorial/rest.html) or [Other programming languages](/tutorial/other_langs.html) for other approaches.

To get started using Bitcoin Cash on your site, include this tag in your `<head>` section:

```html
<script src="https://cdn.mainnet.cash/mainnet-0.1.5.js"
 integrity="sha384-CPKigz4DprdLsGjkL7KdJHs0BBziT4VG62BZdqauo/Aujq9ygLMI2zcGdGLKfW3E"
 crossorigin="anonymous"></script>
```

<!--
you can generate the integrity sha like in the following example:
echo sha384-`curl https://cdn.mainnet.cash/mainnet-0.1.5.js | openssl dgst -sha384 -binary | openssl base64 -A`
-->

Note that the `integrity` part guarantees that the script haven't been tampered with. So if a hacker replaces it,
the user's browser will not run the script. Or you can download the library and serve it locally.

Now, you can create a test wallet:

```js
const wallet = await TestNetWallet.newRandom();
```

This wallet will not be persisted, if a user closes his browser, it's gone forever. See below for persistent wallets.

This creates a **TestNet** wallet.

::: tip What is TestNet? Where to get TestNet money and a wallet?

`TestNet` is where you test your application. TestNet money has no price. Opposite of TestNet is `MainNet`, 
which is what people usually mean when they talk about Bitcoin Cash network.  You can get free TestNet money [here](https://faucet.fullstack.cash/).
If you need a wallet that supports the TestNet, download [Electron Cash](https://electroncash.org/) and
run it using `electron-cash --testnet` flag. For example, on MacOS that would be:

`/Applications/Electron-Cash.app/Contents/MacOS/Electron-Cash --testnet`


:::

To create a MainNet wallet (Bitcoin Cash production network):

```js
const wallet = await Wallet.newRandom();
```

If you want to create a wallet from a mnemonic seed phrase, use this call:

```js
const wallet = Wallet.fromSeed('.....');
```

::: tip
Seed phrase wallets use the derivation path `m/44'/0'/0'/0/0` by default (Bitcoin.com wallet compatibility)
:::

Optionally, a [BIP44](https://github.com/bitcoin/bips/blob/master/bip-0044.mediawiki) derivation path may be added as a second argument.

```js
const wallet = Wallet.fromSeed("horse duck stapler...", "m/44'/1'/145'/0/0");
```

If you want to create a wallet from a WIF (private key), use this call:

```js
const wallet = Wallet.fromWIF('.....');
```

Networks: 

- mainnet: `Wallet`
- Testnet: `TestNetWallet`
- RegTest: `RegTestWallet` ([see below](#regtest-wallets))

## Named wallets (persistent)

Named wallets are used to saved the private key generated by the browser, so that you
can run ```await Wallet.named(`user`)``` and always get the same wallet back.

Note that it's better to run something like ```await Wallet.named(`user:${id}`)```, i.e. use some ID of the user,
so that if the same browser has multiple users, they'll all get their own wallet. (Like, if a user has multiple accounts on your site)

To create a persistent wallet (saved to the IndexedDB of user's browser):

```js
const wallet = await TestNetWallet.named('user:1234');
```

`user:1234` is an optional name for the wallet. The wallet is saved in user's browser for future re-use.

## Getting the balance

To get the balance of the wallet you can do this:

```js
await seller.getBalance('usd') // 0.00
await seller.getBalance('bch') // 0.00
await seller.getBalance('sat') // 0
```

You can ask for `usd`, `sat`, `bch` (or `satoshi`, `satoshis`, `sats` - just in case you forget the exact name).

- 1 satoshi = 0.000 000 01 Bitcoin Cash
- 1 Bitcoin Cash = 100,000,000 satoshis

`USD` returns the amount at the current exchange rate.

### Watch-only wallets

You can find out a balance of any cashaddr (say `bchtest:qq1234567`) like this:

```js
const wallet = await TestNetWallet.watchOnly('bchtest:qq1234567');
await wallet.getBalance('usd');
```

## Sending money

Let's create another wallet and send some of our money there:

```js
const seller = await TestNetWallet.named('seller');

const txData = await wallet.send([
    [seller.depositAddress(), 0.01, 'USD'],
]);
```

Note that you can send to many addresses at once.

Let's print the balance of the seller's wallet:

```js
console.log(await seller.getBalance('USD'));
// 0.01
```

Great! You've just made your first transaction!

Now you can send all of your money somewhere else:

```js
const txData = await seller.sendMax(wallet.depositAddress());
```

## Waiting for a transaction

### QR codes

Let's say you want to display a QR code for you user to pay you money and show an alert when money arrives?

Let's display a QR code first. Create a placeholder first:

```html
<p style="text-align: center;">
    <img src="https://cdn.mainnet.cash/wait.svg" style="width: 15em;" id="deposit">
</p>
```

Then you can replace it with an actual QR code of the deposit address:

```js
document.querySelector('#deposit').src = wallet.getDepositQr().src;
```

### Waiting

You can wait for a certain minimal balance on the wallet using the `waitForBalance` function.

```js
let balance = await wallet.waitForBalance(1.0, 'usd');
````

The `balance` variable contains the actual balance of the wallet.

## Escrow contracts

::: warning
Not fully tested yet
:::

Ok, let's now assume that you are building a service where you want to connect a buyer and a seller (a freelance marketplace 
or a non-custodial exchange), but at the same time you don't want to hold anyone's money, 
but only act as an arbiter in case something goes wrong. It's possible in Bitcoin Cash and it's called "an escrow contract".

You'll need three addresses for this: `buyer`, `seller` and `arbiter`. 

Note: The source for the contract is [here](https://github.com/mainnet-cash/mainnet-js/blob/a35c3ff9590eb04e03b122d7bb2d4bbb12150d66/src/contract/escrow/EscrowContract.ts#L98-L118). 

1) Buyer sends the money to the contract and could then release the money to the seller 
2) The seller could refund the buyer
3) Arbiter can either complete the transaction to the seller or refund to the buyer, but cannot steal the money 

```js
let escrow = new EscrowContract({
  arbiterAddr: arbiter.getDepositAddress(),
  buyerAddr: buyer.getDepositAddress(),
  sellerAddr: seller.getDepositAddress(),
});
```

You can now send money to the contract:

```js
await buyer.send([ [ escrow.getAddress(), 3700, "satoshis" ], ]);
``` 

Check the balance of the contract (in satoshis):

```js
await escrow.getBalance()
// 3700
```

Note: Escrow contract is big (in bytes) and requires a big fee, so the minimum what you can send to it is about 3700 satoshis. 

Now, we can execute the necessary functions:

1) Buyer releases the funds
```js
await escrow.run(buyer.privateKeyWif, "spend");
```

2) Seller refunds
```js
await escrow.run(seller.privateKeyWif, "refund");
```

3) Arbiter releases the funds or refunds
```js
await escrow.run(arbiter.privateKeyWif, "spend");
await escrow.run(arbiter.privateKeyWif, "refund");
```

### Saving the contract to the database

The arbiter needs to save the contract somewhere (in a database or some other storage), so that when the time comes,
he could execute the necessary functions:

Save:

```js
const contractId = escrow.toString();
```

Restore it later:

```js
const restoredEscrow = EscrowContract.fromId(contractId);
```

## CashScript

Somewhat done, but not yet documented...

## Utilities


### Currency conversions

Need to find out how many BCH are there currently in 1 USD, or find out how many satoshis are there in 100 USD? Easy!

```js
await convert(100, "usd", "sat")
// 28067024
```

[filename](_regtest.md ':include')

## RegTest wallets

During the local development and testing, you might not want to use TestNet coins, so you can use so-called "RegTest wallets".

::: tip What is RegTest?

`RegTest` is a mode, in which you can run your Bitcoin Cash node locally, and you can get as many test coins as you need, 
but they exist on your machine only. RegTest wallets are supported by the mainnet library.

:::

A full Bitcoin node, an Electrum server and open Postgres server configuration is available for testing in a 
Docker Compose file at `jest/regtest-docker-compose.yml`

It can be brought up with:

```bash
./jest/docker/start.sh 
```

To stop it:

```bash
./jest/docker/stop.sh
```

The Electrum server (Fulcrum) is available at `ws://127.0.0.1:60003` on your local machine.  
The regtest BCHN node is on port `18443` available with RPC using credentials in `.env.regtest`. 
An open Postgres server is also available on port `15432`

To use this wallet from your code:

```js
const wallet = await RegTestWallet.newRandom();
```

## WebSockets

We provide some functionality over websockets where traditional REST servers would timeout. Examples are waiting for transactions and watching balances .
Websockets allow to subscribe to server events, sending responses and notifications asynchronously.

Check out the jsfiddle [demo](https://jsfiddle.net/Lm87yzuj/6/)

Websockets are supported by all major browsers and using them is easy, no external libraries are needed:

```js
// create websocket and connect it to mainnet
let socket = new WebSocket("wss://rest-unstable.mainnet.cash/api/v1/wallet");

// make a request to subscribe to bakance changes of a wallet
socket.onopen = (event) => {
  // request body
  const balanceRequest = {method: "watchBalance", data: {address: "qzxzl07tth5qx4shphrpzz38wnstwac5ksqnc6yyr3"}};
  // send request
  socket.send(JSON.stringify(balanceRequest));
};

// receive server replies and log them
socket.onmessage = (event) => {
  let response = JSON.parse(event.data);
  console.log(response);
};
```

The output of this code snippet will look like this:

```json
{
  bch: 0.00009383,
  sat: 9383,
  usd: 0.029358468699999998
}
```

See [websocket API reference](/additional/websockets.html)

## Changing Networks Providers

By default, creating a new wallet will create a connection 
to a server communicating over the [electrum cash protocol](https://bitcoincash.network/electrum/).

However, if there are issues it may be necessary to set it manually.

